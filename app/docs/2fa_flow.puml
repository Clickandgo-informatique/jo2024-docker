@startuml
title Flux 2FA

skinparam activity {
  FontName Arial
  FontSize 12
  ArrowColor #333333
  BackgroundColor #F0F8FF
  BorderColor #4682B4
}

start

' ======================
' Login
' ======================
:ğŸ“ Page de login;

if (ğŸ”‘ Utilisateur valide ?) then (Non)
  ->âŒ Retour page login;
  stop
else (Oui)
  if (2FA activÃ©e ?) then (Non)
    ->âœ… Connexion normale vers app_main;
    stop
  else (Oui)
    ->ğŸ”’ Redirection vers page 2FA verify;
  endif
endif

' ======================
' 2FA Verify
' ======================
if (Code 2FA correct ?) then (Non)
  ->âŒ Rester sur page 2FA verify;
else (Oui)
  ->ğŸ‘¤ Authentifie complÃ¨tement l'utilisateur;
  if (ROLE_ADMIN ?) then (Oui)
    ->ğŸ›¡ï¸ Redirection vers app_admin_index;
  else (Non)
    ->ğŸ  Redirection vers app_main;
  endif
endif

' ======================
' Setup 2FA
' ======================
:âš™ï¸ Page /2fa/setup;

if (Utilisateur connectÃ© ?) then (Non)
  ->âŒ Retour page login;
else (Oui)
  if (Secret 2FA prÃ©sent ?) then (Non)
    ->âŒ Retour page login;
  else (Oui)
    ->ğŸ“· Affiche QR code et formulaire;
    if (Code 2FA validÃ© ?) then (Non)
      ->âŒ Rester sur setup 2FA;
    else (Oui)
      ->âœ… Active 2FA pour l'utilisateur;
      ->ğŸ  Redirection vers app_main;
    endif
  endif
endif

stop

' ======================
' LÃ©gende
' ======================
legend right
  ğŸ”‘ = VÃ©rification des identifiants
  ğŸ”’ = VÃ©rification code 2FA
  ğŸ›¡ï¸ = Redirection admin
  ğŸ  = Redirection utilisateur
  âš™ï¸ = Setup 2FA
  ğŸ“· = QR code affichÃ©
  âœ… = SuccÃ¨s
  âŒ = Erreur / retour
endlegend

@enduml
